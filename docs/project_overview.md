# 移动互联网应用开发 大作业

## 作业要求

- 客户端
  - 登陆注册机制
    - 通过导航实现页面的切换和数据传递
  - 页面响应式优化
  - 多线程优化（是否有必要？）
- 服务端
  - 技术栈：Python, FastAPI, Sqlite3, Loguru, (ollama 或等效多模态LLM接口)
  - RESTful API
    - FastAPI
  - 鉴权机制
    - 持久化存储
    - 对于每个用户随机化生成唯一token；使用账号-密码验证登陆账号，使用token验证访问接口
  - 数据持久化：sqlite3
  - 错误处理
    - 错误码约定
  - 日志记录
    - Loguru
  - 大模型：MiniCPM-V

## 项目结构

- 前端
  - 注册、登录页面
    - **注册页面**
      - 要求用户提供用户名、密码和重复输入密码
      - 收到用户输入后进行合法性检查（非法字符、注入等问题）
      - 检查通过后调用`/register` API，并检查返回值（注册是否成功）
    - **登录页面**
      - 要求用户提供用户名和密码
      - 收到输入后进行合法性检查
      - 检查通过后调用`/login` API，并检查返回值
        - 若登录失败，根据返回的错误代码提示对应的原因
        - 若登录成功，则将返回的`user_token`存储在本地
    - 两个页面能进行互相跳转（注册账号 / 返回登录）
    - 可选：**密码加密传输？**
  - 应用主要页面
    - 下列两个页面在底栏`Navigation`组件中切换
    - **历史页面**
      - 调用`/history` API展示用户生成过的内容
      - 点击历史记录中的任意一项可以跳转至对应项的**展示页面**
        - **展示页面**：展示用户上传的图片和生成的标题、描述。
        - *做的精致一点*
      - 若没有生成过内容则显示提示信息（去生成）
      - 右上角`+`按钮，点击调用系统的选择图片功能
        - 确定选择后显示**确认页面**
        - **确认页面**：对应图片的预览 + 确认按钮；用户确认后调用`/generate` API，获得返回任务的`request_token`后存储在本地
          - 从该页面返回可取消选择（返回至历史页面）
          - 获得`request_token`后将该项目在历史列表中渲染为正在生成的状态
          - 定时调用`/request_status` API来刷新 **正在生成任务的** 进度、排队信息等
          - 若生成成功则调用`/history` API刷新历史列表
    - **个人信息 / 关于页面**
      - 显示用户的个人信息（用户名）和项目信息
      - 可选：头像、更改密码、更改用户名、退出登录？
- 后端
  - 数据库
    - 用户表：存储每一个用户账号的`username, user_token, password`信息
    - 任务表：存储每一个生成任务的`request_token, user_token, image, title, desc`信息
    - 两个数据库均为单例，全局可访问。
    - 当用户调用`/history`查询生成历史时，从任务表中查询`user_token`与当前用户`user_token`相同的记录并返回。
  - 注册和登录
    - 当用户注册时，在表中查询是否已经存在相同用户名的用户；若存在则返回错误信息，不存在则使用`uuid`为用户生成一个全局唯一的`user_token`，并和`username, password`一同存储在数据库中。
    - 当用户登录时，在数据库中查询对应的表项；若不存在，返回错误信息；若存在则进行密码匹配，匹配成功返回`user_token`，不成功则返回错误信息。
  - 生成队列
    - 维护一个生成任务队列，满足先进先出要求。
    - 当用户调用`/generate`发送请求时，为请求生成一个`request_token`，将请求加入队尾，并返回`request_token`。
    - 当用户调用`/request_status`时，先在任务队列中查找对应的任务是否存在；若存在则返回剩余任务数，不存在则在数据库中查找该任务，若存在则返回任务状态，不存在则返回错误信息。
    - 定时检查（如每秒检查一次）任务队列是否为空，若非空则取出第一个任务开始生成，生成完成后将任务从队列中移除，并将任务信息和生成结果存储在任务数据库中。

## API定义

- `POST /register`
  - 字段：
    - `username`: `string`类型，用户名，**不允许重名**
    - `password`: `string`类型，密码
  - 返回字段（JSON）：
    - `success`: `bool`类型，注册是否成功
    - `error_msg`: `string`类型，注册失败时返回的错误信息
- `POST /login`
  - 字段：
    - `username`: `string`类型，用户名
    - `password`: `string`类型，密码
  - 返回字段（JSON）：
    - `success`: `bool`类型，登录是否成功
    - `user_token`: `string`类型，用户的唯一标识符
    - `error_msg`: `string`类型，登录失败时返回的错误信息
- `POST /history`
  - 字段：
    - `user_token`: `string`类型，用户的唯一标识符
  - 返回字段（JSON）：
    - `items`: `list[item]`类型，生成记录
    - `item`: `dict`类型，单个生成记录
      - 字段：
        - `image`：`string`类型，`base64`编码的图片
        - `title`：`string`类型，生成的标题
        - `desc`：`string`类型，生成的描述
- `POST /generate`
  - 字段：
    - `user_token`: `string`类型，用户的唯一标识符
    - `image`: `string`类型，`base64`编码的图片
  - 返回字段（JSON）：
    - `request_token`: `string`类型，请求的唯一标识符
    - `error_msg`: `string`类型，生成失败时返回的错误信息
- `POST /request_status`
  - 字段：
    - `request_token`: `string`类型，请求的唯一标识符
  - 返回字段（JSON）：
    - `finished`： `boolean`类型，生成是否完成
    - `index`：`int`类型，前面剩余多少个生成任务